<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABQ Dining Map</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{ --bg:#f7f7f8; --panel:#fff; --text:#111418; --muted:#6b7280; --shadow:0 8px 30px rgba(0,0,0,.08); --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial}
    #app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;align-items:center;gap:.6rem;padding:10px 14px;background:var(--panel);box-shadow:var(--shadow);position:sticky;top:0;z-index:1000}
    .title{font-weight:600}
    #map{height:100%}
    .controls{position:absolute;top:12px;right:12px;display:flex;flex-direction:column;gap:10px;z-index:1001}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;min-width:260px;max-width:360px}
    .card h3{margin:0 0 8px 0;font-size:14px;font-weight:600}
    .legend-row{display:flex;align-items:center;gap:8px;font-size:13px;padding:6px 0}
    .chip{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,.1)}
    .select{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px;background:#fafafa}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:8px 12px;font-size:13px;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{border-color:#dbeafe;background:#f0f7ff;color:#0b63d1}
    .leaflet-control-attribution{font-size:10px;color:var(--muted)}
    .popup{max-width:320px}
    .popup h4{margin:0 6px 4px 6px;font-size:16px;line-height:1.3}
    .popup .meta{font-size:12px;color:#6b7280;margin:0 6px 8px 6px}
    .popup .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fafafa;margin:0 6px 8px 6px}
    .popup .kvs{display:grid;grid-template-columns:88px 1fr;gap:6px 8px;padding:0 6px 6px 6px}
    .popup .kvs dt{font-size:12px;color:#374151;text-align:right;opacity:.85}
    .popup .kvs dd{font-size:13px;margin:0}
    .popup .btns{display:flex;gap:8px;flex-wrap:wrap;padding:8px 6px 4px 6px}
    .popup .btns a{flex:1 1 140px;text-align:center}
    .hotel-star svg{filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2c2.5 4.2 5.3 6.4 8.4 6.5-2.1 6.7-5.5 10.6-8.4 13-2.9-2.4-6.3-6.3-8.4-13C6.7 8.4 9.5 6.2 12 2Z" stroke="#0a84ff" stroke-width="1.2"/></svg>
      <div class="title">ABQ Dining Near DoubleTree</div>
    </header>

    <div style="position:relative;">
      <div id="map"></div>
      <div class="controls">
        <div class="card">
          <h3>Legend</h3>
          <div class="legend-row"><span class="chip" style="background:#5b93ff"></span> Walking Downtown (0–1 Mile)</div>
          <div class="legend-row"><span class="chip" style="background:#8bd46a"></span> Beyond the Block (1–3 Miles)</div>
          <div class="legend-row"><span class="chip" style="background:#f3c96b"></span> Quick Adventure (3–5 Miles)</div>
          <div class="legend-row"><span class="chip" style="background:#d89ef9"></span> Worth the Drive (5+ Miles)</div>
          <div style="margin-top:8px">
            <select id="placeSelect" class="select">
              <option value="">Quick jump to a restaurant</option>
            </select>
          </div>
          <div class="btns" style="margin-top:8px">
            <button class="btn primary" id="centerHotelBtn">Center on Hotel</button>
            <button class="btn" id="useLocationBtn">Use My Location</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const HOTEL = { name: "DoubleTree by Hilton Downtown Albuquerque", lat: 35.088451, lng: -106.649013 };
    const INITIAL_ZOOM = 15;
    const FIT_TO_BOUNDS_ON_LOAD = false;

    const COLORS = {
      "Walking Downtown (0–1 Mile)": "#5b93ff",
      "Beyond the Block (1–3 Miles)": "#8bd46a",
      "Quick Adventure (3–5 Miles)": "#f3c96b",
      "Worth the Drive (5+ Miles)": "#d89ef9"
    };

    // ===== Data (updated with Monte Carlo zip fix) =====
    const PLACES = [
      // Walking Downtown (0–1 Mile)
      { area: "Walking Downtown (0–1 Mile)", name: "My Mom’s – Breakfast", price: "$$", address: "500 4th St NW #106, Albuquerque, NM 87102", distance: "0.1 mi", phone: "(505) 247-2943", hours: "Mon–Fri 8a–2p" },
      { area: "Walking Downtown (0–1 Mile)", name: "CHAR (Hotel Andaluz) – American", price: "$$$", address: "125 2nd St NW, Albuquerque, NM 87102", distance: "0.2 mi", phone: "(505) 242-9080", hours: "Daily 7a–10p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Oni Ramen – Japanese / NM Fusion", price: "$$", address: "600 Central Ave SW #100, Albuquerque, NM 87102", distance: "0.3 mi", phone: "(505) 503-6722", hours: "Daily 11:30a–8p" },
      { area: "Walking Downtown (0–1 Mile)", name: "505 Central Food Hall – Food Hall", price: "$ Varies", address: "505 Central Ave NW, Albuquerque, NM 87102", distance: "0.3 mi", phone: "Varies by Vendor", hours: "Usually 11a–9p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Slate Street Café – Café", price: "$$", address: "515 Slate Ave NW, Albuquerque, NM 87102", distance: "0.4 mi", phone: "(505) 243-2210", hours: "Mon–Fri 8a–2p, Sat 9a–2p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Tractor Brewing Company Wells Park – Brewery", price: "$$", address: "1800 4th St NW, Albuquerque, NM 87102", distance: "1.2 mi", phone: "(505) 243-6752", hours: "Mon 4–9p, Tue–Thu 2–10p, Fri 2–12a, Sat 1–11p, Sun 1–10p" },
      { area: "Beyond the Block (1–3 Miles)", name: "The Grove Cafe & Market", price: "$$", address: "600 Central Ave SE, Albuquerque, NM 87102", distance: "1.7 mi", phone: "(505) 248-9800", hours: "Tue–Sun 8a–2p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Range Café Downtown – New Mexican", price: "$$", address: "320 Central Ave SE, Albuquerque, NM 87102", distance: "0.4 mi", phone: "(505) 243-1440", hours: "Daily 7a–3p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Founders Speakeasy – Basement Speakeasy", price: "$$", address: "622 Central Ave SW, Albuquerque, NM 87102", distance: "0.5 mi", phone: "(505) 582-2693", hours: "Tues–Sat 5p–2a, Sun–Mon 5p–12a" },
      { area: "Walking Downtown (0–1 Mile)", name: "The Artichoke Café – American", price: "$$", address: "424 Central Ave SE, Albuquerque, NM 87102", distance: "0.5 mi", phone: "(505) 243-0200", hours: "Mon–Thu 11a–9p, Fri–Sat 11a–10p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Marble Brewery – Brewery", price: "$$", address: "111 Marble Ave NW, Albuquerque, NM 87102", distance: "0.5 mi", phone: "(505) 243-2739", hours: "Daily 11:30a–10p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Farina Pizzeria & Wine Bar", price: "$$", address: "510 Central Ave SE, Albuquerque, NM 87102", distance: "0.6 mi", phone: "(505) 243-0130", hours: "Mon–Sat 11a–9p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Cocina Azul – New Mexican", price: "$$", address: "1134 Mountain Rd NW, Albuquerque, NM 87104", distance: "0.7 mi", phone: "(505) 831-2500", hours: "Daily 9a–8p" },
      { area: "Walking Downtown (0–1 Mile)", name: "Monroe’s – Classic New Mexican Breakfast", price: "$$", address: "1025 4th St NW, Albuquerque, NM 87102", distance: "0.7 mi", phone: "(505) 242-1111", hours: "Sun 9a–8p, Mon–Tue & Thu–Sat 10a–8p" },

      // Beyond the Block (1–3 Miles)
      { area: "Beyond the Block (1–3 Miles)", name: "Kosmos Restaurant & Astropub – American", price: "$$", address: "1715 5th St NW, Albuquerque, NM 87102", distance: "1.2 mi", phone: "(505) 369-1772", hours: "Tue–Thu 11:30a–8p, Fri–Sat 11:30a–9p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Laguna Burger (Old Town) – Burgers", price: "$$", address: "2400 12th St NW, Albuquerque, NM 87104", distance: "2.0 mi", phone: "(505) 352-8282", hours: "Daily 10:30a–8p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Indian Pueblo Kitchen – Native American", price: "$$", address: "2401 12th St NW, Albuquerque, NM 87104", distance: "2.1 mi", phone: "(505) 724-3510", hours: "Wed–Sun 8a–3p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Monte Carlo Steakhouse – Steakhouse", price: "$$$", address: "3916 Central Ave SW, Albuquerque, NM 87105", distance: "2.2 mi", phone: "(505) 836-9886", hours: "Mon–Sat 11a–9p" },
      { area: "Beyond the Block (1–3 Miles)", name: "66 Diner – Diner", price: "$$", address: "1405 Central Ave NE, Albuquerque, NM 87102", distance: "2.3 mi", phone: "(505) 247-1421", hours: "Mon–Thu 11a–9p, Fri–Sat 11a–10p, Sun 11a–8p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Frontier Restaurant – Diner", price: "$$", address: "2400 Central Ave SE, Albuquerque, NM 87106", distance: "2.5 mi", phone: "(505) 266-0550", hours: "Daily 5a–12a" },
      { area: "Beyond the Block (1–3 Miles)", name: "Sawmill Market – Food Hall", price: "$ Varies", address: "1909 Bellamah Ave NW, Albuquerque, NM 87104", distance: "2.8 mi", phone: "(505) 498-2982", hours: "Sun–Thu 8a–9p, Fri–Sat 8a–10p" },
      { area: "Beyond the Block (1–3 Miles)", name: "Annapurna’s Vegetarian Café – Vegetarian", price: "$$", address: "2201 Silver Ave SE, Albuquerque, NM 87106", distance: "2.8 mi", phone: "(505) 262-2424", hours: "Daily 9a–8p" },

      // Quick Adventure (3–5 Miles)
      { area: "Quick Adventure (3–5 Miles)", name: "M’tucci’s Bar Roma – Italian", price: "$$$", address: "3222 Central Ave SE, Albuquerque, NM 87106", distance: "3.3 mi", phone: "(505) 508-2745", hours: "Sun–Thu 11a–9p, Fri–Sat 11a–10p" },
      { area: "Quick Adventure (3–5 Miles)", name: "Guava Tree Café – Latin American", price: "$$", address: "118 Richmond Dr NE, Albuquerque, NM 87106", distance: "3.0 mi", phone: "(505) 990-2599", hours: "Tue–Sat 11a–4p" },
      { area: "Quick Adventure (3–5 Miles)", name: "Tula’s Kitchen – American", price: "$$", address: "1825 Central Ave NW, Albuquerque, NM 87104", distance: "4.0 mi", phone: "(505) 200-2666", hours: "Tue–Sun 9a–9p" },
      { area: "Quick Adventure (3–5 Miles)", name: "El Pinto Restaurant & Cantina – New Mexican", price: "$$", address: "10500 4th St NW, Albuquerque, NM 87114", distance: "4.8 mi", phone: "(505) 898-1771", hours: "Daily 11a–9p" },

      // Worth the Drive (5+ Miles)
      { area: "Worth the Drive (5+ Miles)", name: "Farm & Table – Upscale Dining", price: "$$$", address: "8917 4th St NW, Albuquerque, NM 87114", distance: "5.0 mi", phone: "(505) 503-7124", hours: "Wed–Sat 5p–9p, Sun 9a–2p" },
      { area: "Worth the Drive (5+ Miles)", name: "Sadie’s of New Mexico – New Mexican", price: "$$", address: "6230 4th St NW, Los Ranchos de Albuquerque, NM 87107", distance: "5.5 mi", phone: "(505) 345-5339", hours: "Daily 11a–9p" },
      { area: "Worth the Drive (5+ Miles)", name: "Vernon’s Speakeasy – Upscale Speakeasy", price: "$$$$", address: "6855 4th St NW, Los Ranchos de Albuquerque, NM 87107", distance: "5.6 mi", phone: "(505) 341-0831", hours: "Wed–Fri & Sun 4p–10p, Sat 4p–10p, Closed Mon–Tue" },
      { area: "Worth the Drive (5+ Miles)", name: "M’tucci’s – Italian (NE location)", price: "$$$", address: "4939 Pan American Fwy NE, Albuquerque, NM 87109", distance: "6.0 mi", phone: "(505) 312-8519", hours: "Daily 11a–10p" },
      { area: "Worth the Drive (5+ Miles)", name: "Los Poblanos Campo Restaurant – Farm Dining", price: "$$$", address: "4803 Rio Grande Blvd NW, Albuquerque, NM 87107", distance: "6.2 mi", phone: "(505) 344-9297", hours: "Wed–Sun 5p–9p, Sat & Sun Brunch 9a–2p" },
      { area: "Worth the Drive (5+ Miles)", name: "Japanese Kitchen – Teppanyaki & Sushi", price: "$$$", address: "6521 Americas Pkwy NE, Albuquerque, NM 87110", distance: "6.2 mi", phone: "(505) 884-8937", hours: "Lunch Mon–Sat 11:30a–2:30p, Dinner Daily 5p–9p" },
      { area: "Worth the Drive (5+ Miles)", name: "TEN3 at Sandia Peak Tram – Upscale Dining", price: "$$$$", address: "30 Tramway Rd NE, Albuquerque, NM 87122", distance: "9.8 mi", phone: "(505) 856-6692", hours: "Mon–Thu 11a–9p, Fri–Sat 11a–9:30p, Sun 11a–8p" }
    ];

    // ===== Map Setup =====
    const map = L.map('map', { zoomControl:false, attributionControl:true }).setView([HOTEL.lat, HOTEL.lng], INITIAL_ZOOM);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap & CARTO' }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    // Hotel gold star
    const hotelIcon = L.divIcon({
      className:'hotel-star', iconSize:[34,34], iconAnchor:[17,17], popupAnchor:[0,-12],
      html:'<svg width="34" height="34" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.8 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z" fill="#FFD700" stroke="#B8860B" stroke-width="1"/></svg>'
    });
    const hotelMarker = L.marker([HOTEL.lat, HOTEL.lng], { icon: hotelIcon }).addTo(map)
      .bindPopup(`<div class="popup"><h4>${HOTEL.name}</h4><div class="meta">Hotel</div><div class="row"><strong>Lat/Lng</strong>${HOTEL.lat.toFixed(6)}, ${HOTEL.lng.toFixed(6)}</div></div>`);

    // ===== Helpers =====
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const cacheKey = addr => `geocode:${addr}`;
    async function geocode(addr){
  const key = cacheKey(addr);
  const cached = localStorage.getItem(key);
  if(cached){ try{return JSON.parse(cached)}catch(_){}}

  async function lookup(q){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
    const resp = await fetch(url,{headers:{'Accept':'application/json'}});
    const data = await resp.json();
    return data && data[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
  }

  // exact
  let best = await lookup(addr);
  // simplified without unit/suite
  if(!best){
    const simplified = addr.replace(/,?\s*(Unit|Suite|Ste|#)\s*[A-Za-z0-9-]+/i, '');
    if(simplified !== addr) best = await lookup(simplified);
  }
  // name + city
  if(!best){
    const p = (PLACES||[]).find(x=>x.address===addr);
    if(p) best = await lookup(p.name + ', Albuquerque, NM');
  }

  if(best){ localStorage.setItem(key, JSON.stringify(best)); }
  await sleep(200);
  return best;
}

    function popupHtml(p){
      const digits = (p.phone||'').replace(/[^0-9]/g,'');
      const phoneVal = p.phone ? (digits ? `<a href="tel:${digits}">${p.phone}</a>` : `${p.phone}`) : '';
      const mapsQuery = encodeURIComponent(`${p.name} ${p.address}`);
      const appleUrl = `https://maps.apple.com/?q=${mapsQuery}`;
      const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${mapsQuery}`;
      return `<div class="popup">
        <h4>${p.name}</h4>
        <div class="meta">${p.area} • ${p.distance}</div>
        ${p.price ? `<div class="badge">Price: ${p.price}</div>` : ''}
        <dl class="kvs">
          <dt>Address</dt><dd>${p.address||''}</dd>
          ${phoneVal ? `<dt>Phone</dt><dd>${phoneVal}</dd>` : ''}
          ${p.hours ? `<dt>Hours</dt><dd>${p.hours}</dd>` : ''}
        </dl>
        <div class="btns">
          <a class="btn" href="${appleUrl}" target="_blank" rel="noopener">Open in Apple Maps</a>
          <a class="btn" href="${gmapsUrl}" target="_blank" rel="noopener">Open in Google Maps</a>
        </div>
      </div>`;
    }

    const groups = {
      "Walking Downtown (0–1 Mile)": L.layerGroup().addTo(map),
      "Beyond the Block (1–3 Miles)": L.layerGroup().addTo(map),
      "Quick Adventure (3–5 Miles)": L.layerGroup().addTo(map),
      "Worth the Drive (5+ Miles)": L.layerGroup().addTo(map)
    };

    const markersByName = new Map();

    async function addPlaces(){
      const sel = document.getElementById('placeSelect');
      const byArea = {};
      PLACES.forEach(p => { (byArea[p.area] ||= []).push(p); });

      // Build quick-jump grouped by area
      Object.keys(byArea).forEach(area => {
        const og = document.createElement('optgroup');
        og.label = area;
        byArea[area].forEach(p => {
          const opt = document.createElement('option');
          opt.textContent = p.name; opt.value = p.name; og.appendChild(opt);
        });
        sel.appendChild(og);
      });

      // Geocode and add markers
      const bounds = L.latLngBounds([ [HOTEL.lat, HOTEL.lng] ]);
      for(const p of PLACES){
        const coords = await geocode(p.address);
        if(!coords) continue;
        p.lat = coords.lat; p.lng = coords.lng;
        const color = COLORS[p.area] || '#333';
        const m = L.circleMarker([p.lat, p.lng], { radius:7, color:color, weight:1.25, fillColor:color, fillOpacity:0.9 })
          .bindPopup(popupHtml(p));
        m.addTo(groups[p.area]);
        markersByName.set(p.name, m);
        bounds.extend([p.lat, p.lng]);
      }
      if(FIT_TO_BOUNDS_ON_LOAD){ map.fitBounds(bounds.pad(0.15)); }
    }

    addPlaces();

    // UI wiring
    document.getElementById('centerHotelBtn').addEventListener('click', ()=>{
      map.setView([HOTEL.lat, HOTEL.lng], INITIAL_ZOOM, { animate:true });
      hotelMarker.openPopup();
    });
    document.getElementById('useLocationBtn').addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported.'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        L.circleMarker([latitude, longitude], { radius:7, color:'#0a84ff', weight:2, fillColor:'#0a84ff', fillOpacity:0.9 })
          .addTo(map).bindPopup('<div class="popup"><h4>You are here</h4></div>').openPopup();
        map.setView([latitude, longitude], 14, { animate:true });
      }, (err)=>{ alert('Unable to access location: ' + err.message); }, { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
    });

    document.getElementById('placeSelect').addEventListener('change', (e)=>{
      const m = markersByName.get(e.target.value);
      if(!m){ alert('That place is still loading. Try again in a moment.'); return; }
      map.setView(m.getLatLng(), 16, { animate:true });
      m.openPopup();
      const orig = m.options.radius; let step = 0; const id = setInterval(()=>{
        step++; m.setStyle({ radius: step % 2 ? orig + 4 : orig });
        if(step>6){ clearInterval(id); m.setStyle({ radius: orig }); }
      }, 160);
    });
  </script>
</body>
</html>
